# Zendesk

The purpose of the `CloudTradeZendesk` program is to work with CloudTrade's Zendesk API and automate various
functionality.

One thing to note that the rate limit for the endpoint is 400. To ensure that the limit is not used up this program
adds a 2 second time delay per request and a 30 second time delay when the remaining Api calls fall below 350. Ensure
that the program is not accidentally closed before it finishes execution.

---

## Usage

There are various different functionalty the `CloudTradeZendesk` object provides. Listed below are the functionality
it currently supports:

### Bulk Submitting Mapping Requests

This script is designed to bulk submit new pdf mapping requests into Zendesk. The way this works is a directory with
all the mappings must be specified as well as an empty directory to move the completed mappings to, it only searches
for PDF files so any other filetype will be ignored.

Change the `file_path` variable to the filepath where all the pdfs reside, then change the `move_path` variable to
the path that the pdfs should be moved to when it has been posted into Zendesk and finally change the `customer`
variable to ensure that the subject reflects which customer the mapping is for.

```python
username = 'ct6@cloud-trade.com'
file_path = r'C:\Users\rumee.ahmed\Documents\CloudTradeScripts\Mapping Requests\files'
move_path = r'C:\Users\rumee.ahmed\Documents\CloudTradeScripts\Mapping Requests\moved_files'
customer = 'Test'
```

---

### Closing Monthly Time Tracking Tickets

This script will also close any tickets that has the tag `monthly_time_tracking` that have been created since the
`1st` of the current month. It is designed to run on the last day of every month.

First instantiate the `CloudTradeZendesk` object that only takes in one parameter, which is the username. For this
feature the username needs to be an agent within CloudTrade, so using a staff member who is an agent on Zendesk is 
acceptable. The `submit_monthly_tickets` method will handle the HTTP request that searches for and submits monthly
tickets.

```python
zendesk = CloudTradeZendesk('rumee.ahmed@cloud-trade.com')
zendesk.submit_monthly_tickets()
```

**Note that the all the mandatory fields `Channel Partner`, `Customer`, `Ticket Type` and `Chargeable/Non-Chargeable`
must be filled out beforehand. Any tickets without these parameters will not be closed.**

---

### Closing Junk Ariba Tickets

This script will also close any junk tickets coming from Ariba's customer support email. It will search for tickets
with the following subjects:
- subject "Your Service Requests have been closed"
- subject "Your Ariba Request was Unable to be Processed"

These are the two main types of tickets that are sent as spam to the helpdesk. It is designed to be executed as a
daily script. First instatiate the `CloudTradeZendesk` with an email which is an agent in the helpdesk. The use the
`submit_junk_ariba_tickets` method and pass in the search query parameter, in this case the search is taking place
by the contents of the tickets subject. The method will then find the tickets with the subject and then close them.

```python
zendesk = CloudTradeZendesk('rumee.ahmed@cloud-trade.com')
zendesk.submit_junk_ariba_tickets('subject "Your Service Requests have been closed"')
zendesk.submit_junk_ariba_tickets('subject "Your Ariba Request was Unable to be Processed"')
```

### Closing Intervention Tickets

This script will also close any open intervention tickets that is generated by the portal, based on the
ticket requester `requester:intervention.queues@cloud-trade.com`. Ensure that all the ticket fields are 
already generated otherwise the program is currently using the following:
- Channel Partner: CloudTrade
- Customer: Operations
- Ticket Type: Intervention
- Chargeable/Non-Chargeable: Non-Chargeable

First instantiate the `CloudTradeZendesk` object with a username and then call the `submit_intervention_tickets`
method. This returns a tuple, the first object is the response object and the second is the total count of 
the tickets in Zendesk. 

```python
zendesk = CloudTradeZendesk('rumee.ahmed@cloud-trade.com')
response, total_count = zendesk.submit_intervention_tickets()
```

This will iterate over the total of the tickets and make calls to the API to close the next batch of 
tickets. As mentioned earlier there are some delays to ensure that the limit is not used up. If 
`total_count2` is equal to 0 then the program will end.

```python
for count in range(total_count):
    response, total_count2 = zendesk.submit_intervention_tickets()
    remaining_api_calls = int(response.headers['X-Rate-Limit-Remaining'])
    time.sleep(2)
    if remaining_api_calls < 350:
        print('Exceeding the API rate limit for this program, waiting 30 seconds.')
        time.sleep(30)
    if total_count2 == 0:
        break
```

---